import cv2 as cv
import numpy as np
import os

# Break a board into tiles
def get_tiles(image):
    tiles = []
    for y in range(5):
        tiles.append([])
        for x in range(5):
            tiles[-1].append(image[y*100:(y+1)*100, x*100:(x+1)*100])
    return tiles

# Determine the type of terrain in a tile
def get_terrain(tile):
    hsv_tile = cv.cvtColor(tile, cv.COLOR_BGR2HSV)
    hue, saturation, value = np.median(hsv_tile, axis=(0,1)) # Consider using median instead of mean
    print(f"H: {hue}, S: {saturation}, V: {value}") #Change value <= (less or equal to)
    if 20 <= hue <= 29 and 220 <= saturation <= 255 and 100 <= value <= 210:
        return "Field"
    if 30 <= hue <= 60 and 78 <= saturation <= 215 and 34 <= value <= 78:
        return "Forest"
    if 100 <= hue <= 110 and 220 <= saturation <= 260 and 108 <= value <= 205:
        return "Lake"
    if 20 <= hue <= 50 and 160 <= saturation <= 245 and 74 <= value <= 170:
        return "Grassland"
    if 15 <= hue < 28.9 and 35 <= saturation <= 165 and 74 <= value <= 178:
        return "Swamp"
    if 20 <= hue < 30 and 40 <= saturation <= 140 and 24 <= value <= 110:
        return "Mine"
    if 29 <= hue <= 35 and 40 <= saturation <= 130 and 40 <= value <= 145:
        return "Home"
    return "Unknown"

# Main function containing the backbone of the program
def main():
    print("+-------------------------------+")
    print("| King Domino points calculator |")
    print("+-------------------------------+")
    image_path = r"C:\Users\marti\Skrivebord\King Domino dataset\1.jpg"
    if not os.path.isfile(image_path):
        print("Image not found")
        return
    image = cv.imread(image_path)
    tiles = get_tiles(image)
    print(len(tiles))

    # Create a copy of the original image for overlaying text
    image_with_text = image.copy()

    # Erklær terræn_count-variablerne
    field_count = 0
    forest_count = 0
    lake_count = 0
    grassland_count = 0
    swamp_count = 0
    mine_count = 0
    home_count = 0

    for y, row in enumerate(tiles):
        for x, tile in enumerate(row):
            print(f"Tile ({x}, {y}):")
            # Erklær ny variabel, terrain
            terrain = get_terrain(tile)
            print(terrain)
            print("=====")

            if terrain == "Field":
                field_count += 1
            if terrain == "Forest":
                forest_count += 1
            if terrain == "Lake":
                lake_count += 1
            if terrain == "Grassland":
                grassland_count += 1
            if terrain == "Swamp":
                swamp_count += 1
            if terrain == "Mine":
                mine_count += 1
            if terrain == "Home":
                home_count += 1

            # Overlay the HSV values on the image with separate lines
            x1, y1, x2, y2 = x * 100, y * 100, (x + 1) * 100, (y + 1) * 100
            hsv_tile = cv.cvtColor(tile, cv.COLOR_BGR2HSV)
            hue, saturation, value = np.median(hsv_tile, axis=(0, 1))
            text = f"H: {hue:.2f}\nS: {saturation:.2f}\nV: {value:.2f}"
            cv.putText(image_with_text, f"H: {hue:.2f}", (x1 + 10, y1 + 20), cv.FONT_HERSHEY_SIMPLEX, 0.4, (0, 255, 0), 1)
            cv.putText(image_with_text, f"S: {saturation:.2f}", (x1 + 10, y1 + 40), cv.FONT_HERSHEY_SIMPLEX, 0.4, (0, 255, 0), 1)
            cv.putText(image_with_text, f"V: {value:.2f}", (x1 + 10, y1 + 60), cv.FONT_HERSHEY_SIMPLEX, 0.4, (0, 255, 0), 1)
   
    cv.namedWindow("Image with HSV Values", cv.WINDOW_NORMAL)
    resized_image = cv.resize(image_with_text, (1000, 1000))

    # Display the image with HSV values in a popup window
    cv.imshow("Image with HSV Values", image_with_text)
    cv.waitKey(0)
    cv.destroyAllWindows()

    # Print the terrain counts and scores
    print("Scoren er derfor:")
    print(f"'Field': \t{field_count}")
    print(f"'Forest': \t{forest_count}")
    print(f"'Lake': \t{lake_count}")
    print(f"'Grassland': \t{grassland_count}")
    print(f"'Swamp': \t{swamp_count}")
    print(f"'Mine': \t{mine_count}")
    print(f"'Home': \t{home_count}")

if __name__ == "__main__":
    main()
